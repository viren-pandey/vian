# VIAN — Mandatory Project Boilerplate
### Plant these EXACT files before ANY AI generation starts.
### Copy every file character-for-character. No changes.

---

## THE PROBLEM THIS FILE SOLVES

The AI sometimes generates:
- Vite projects instead of Next.js → "command not found: vite"
- Wrong folder structure → "Couldn't find app directory"
- Version ranges like ^14 → npm install hangs forever
- Missing postcss → Tailwind doesn't compile
- Missing COOP/COEP headers → WebContainer won't run

This boilerplate is planted FIRST, before the AI runs.
The AI then overwrites only `app/page.tsx` and `components/`.
It never touches `package.json`, `next.config.js`, or config files.

---

## MANDATORY RULE FOR AI GENERATION PROMPT

Add this line to the TOP of every AI system prompt:

```
CRITICAL: This is a Next.js 14 project using the App Router.
NEVER use Vite. NEVER use Create React App. NEVER use Express for the frontend.
ONLY generate files for: app/, components/, lib/, hooks/
NEVER regenerate or modify: package.json, next.config.js, tsconfig.json,
postcss.config.js, tailwind.config.ts
These config files are already correct. Touching them breaks the project.
```

---

## FILE 1 — `package.json`

```json
{
  "name": "vian-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "next": "14.2.5",
    "react": "18.3.1",
    "react-dom": "18.3.1",
    "clsx": "2.1.1",
    "lucide-react": "0.395.0"
  },
  "devDependencies": {
    "@types/node": "20.14.2",
    "@types/react": "18.3.3",
    "@types/react-dom": "18.3.0",
    "autoprefixer": "10.4.19",
    "postcss": "8.4.38",
    "tailwindcss": "3.4.4",
    "typescript": "5.4.5"
  }
}
```

### CRITICAL RULES FOR package.json:
```
✓ "dev": "next dev"          ← MUST be this. Never "vite", never "react-scripts"
✓ "next": "14.2.5"           ← exact version, no ^ or ~
✓ "react": "18.3.1"          ← exact version, no ^ or ~
✓ NO vite, NO webpack, NO parcel in dependencies
✓ AI must NEVER overwrite this file
```

---

## FILE 2 — `next.config.js`

```js
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'Cross-Origin-Embedder-Policy',
            value: 'require-corp',
          },
          {
            key: 'Cross-Origin-Opener-Policy',
            value: 'same-origin',
          },
        ],
      },
    ]
  },
}

module.exports = nextConfig
```

### CRITICAL:
```
✓ module.exports = nextConfig   ← CommonJS, NOT export default
✓ COOP + COEP headers           ← WebContainer WILL NOT WORK without these
✓ AI must NEVER overwrite this file
```

---

## FILE 3 — `tsconfig.json`

```json
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [{ "name": "next" }],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

---

## FILE 4 — `postcss.config.js`

```js
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
```

### CRITICAL:
```
✓ module.exports not export default
✓ This file MUST exist or Tailwind CSS will not compile at all
```

---

## FILE 5 — `tailwind.config.ts`

```ts
import type { Config } from 'tailwindcss'

const config: Config = {
  content: [
    './pages/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
    './app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}

export default config
```

---

## FILE 6 — `app/globals.css`

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  scroll-behavior: smooth;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
    Oxygen, Ubuntu, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
```

### CRITICAL:
```
✓ @tailwind base/components/utilities MUST be first 3 lines
✓ File MUST be at app/globals.css not src/globals.css
```

---

## FILE 7 — `app/layout.tsx`

```tsx
import type { Metadata } from 'next'
import './globals.css'

export const metadata: Metadata = {
  title: 'My App',
  description: 'Generated by VIAN',
}

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  )
}
```

### CRITICAL:
```
✓ imports './globals.css'   ← MUST import CSS here
✓ returns <html><body>      ← MUST have both tags
✓ file at app/layout.tsx    ← NOT src/app/layout.tsx
```

---

## FILE 8 — `app/page.tsx` (Loading Placeholder)

```tsx
export default function Page() {
  return (
    <main
      style={{
        minHeight: '100vh',
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        justifyContent: 'center',
        backgroundColor: '#0a0a0a',
        gap: '16px',
      }}
    >
      <div
        style={{
          width: '10px',
          height: '10px',
          borderRadius: '50%',
          backgroundColor: '#3b82f6',
          animation: 'vian-pulse 1.4s ease-in-out infinite',
        }}
      />
      <p
        style={{
          color: '#555555',
          fontSize: '13px',
          fontFamily: 'monospace',
          letterSpacing: '0.05em',
        }}
      >
        Generating your app...
      </p>
      <style>{`
        @keyframes vian-pulse {
          0%, 100% { opacity: 1; transform: scale(1); }
          50% { opacity: 0.3; transform: scale(0.7); }
        }
      `}</style>
    </main>
  )
}
```

### CRITICAL:
```
✓ Uses ONLY inline styles — no Tailwind, no imports
✓ This renders instantly before CSS compiles
✓ AI overwrites this with real content — that's expected
✓ Never import anything in this file — it must be self-contained
```

---

## FILE 9 — `lib/utils.ts`

```ts
import { type ClassValue, clsx } from 'clsx'

export function cn(...inputs: ClassValue[]): string {
  return clsx(inputs)
}

export function formatDate(date: string | Date): string {
  return new Intl.DateTimeFormat('en-US', {
    month: 'long',
    day: 'numeric',
    year: 'numeric',
  }).format(new Date(date))
}

export function truncate(str: string, length: number): string {
  return str.length > length ? str.slice(0, length) + '...' : str
}
```

---

## THE BOILERPLATE CONSTANT — paste into `lib/boilerplate.ts`

```typescript
// apps/web/lib/boilerplate.ts
// This is the source of truth for all boilerplate files.
// Written to WebContainer before any AI generation begins.

export interface BoilerplateFile {
  path: string
  content: string
}

export const BOILERPLATE_FILES: BoilerplateFile[] = [
  {
    path: 'package.json',
    content: `{
  "name": "vian-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "next": "14.2.5",
    "react": "18.3.1",
    "react-dom": "18.3.1",
    "clsx": "2.1.1",
    "lucide-react": "0.395.0"
  },
  "devDependencies": {
    "@types/node": "20.14.2",
    "@types/react": "18.3.3",
    "@types/react-dom": "18.3.0",
    "autoprefixer": "10.4.19",
    "postcss": "8.4.38",
    "tailwindcss": "3.4.4",
    "typescript": "5.4.5"
  }
}`,
  },

  {
    path: 'next.config.js',
    content: `/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          { key: 'Cross-Origin-Embedder-Policy', value: 'require-corp' },
          { key: 'Cross-Origin-Opener-Policy', value: 'same-origin' },
        ],
      },
    ]
  },
}
module.exports = nextConfig`,
  },

  {
    path: 'tsconfig.json',
    content: `{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [{ "name": "next" }],
    "paths": { "@/*": ["./*"] }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}`,
  },

  {
    path: 'postcss.config.js',
    content: `module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}`,
  },

  {
    path: 'tailwind.config.ts',
    content: `import type { Config } from 'tailwindcss'
const config: Config = {
  content: [
    './pages/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
    './app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: { extend: {} },
  plugins: [],
}
export default config`,
  },

  {
    path: 'app/globals.css',
    content: `@tailwind base;
@tailwind components;
@tailwind utilities;

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; -webkit-font-smoothing: antialiased; }`,
  },

  {
    path: 'app/layout.tsx',
    content: `import type { Metadata } from 'next'
import './globals.css'

export const metadata: Metadata = {
  title: 'My App',
  description: 'Generated by VIAN',
}

export default function RootLayout({
  children,
}: Readonly<{ children: React.ReactNode }>) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  )
}`,
  },

  {
    path: 'app/page.tsx',
    content: `export default function Page() {
  return (
    <main style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', backgroundColor: '#0a0a0a', gap: '16px' }}>
      <div style={{ width: '10px', height: '10px', borderRadius: '50%', backgroundColor: '#3b82f6', animation: 'vian-pulse 1.4s ease-in-out infinite' }} />
      <p style={{ color: '#555555', fontSize: '13px', fontFamily: 'monospace' }}>Generating your app...</p>
      <style>{\`@keyframes vian-pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.3;transform:scale(0.7)} }\`}</style>
    </main>
  )
}`,
  },

  {
    path: 'lib/utils.ts',
    content: `import { type ClassValue, clsx } from 'clsx'
export function cn(...inputs: ClassValue[]): string { return clsx(inputs) }`,
  },
]
```

---

## THE GENERATION HOOK — Full Implementation

```typescript
// apps/web/hooks/useGeneration.ts
'use client'

import { useWebContainer } from './useWebContainer'
import { BOILERPLATE_FILES } from '@/lib/boilerplate'
import { useProjectStore } from '@/stores/projectStore'

export function useGeneration() {
  const { writeFile, install, startDev } = useWebContainer()
  const { setFile, setIsGenerating, model } = useProjectStore()

  async function generate(prompt: string) {
    setIsGenerating(true)

    // ── PHASE 1: Plant all boilerplate files ──────────────────────
    // This happens BEFORE the AI is called.
    // Guarantees Next.js can always boot regardless of what AI generates.
    console.log('[VIAN] Planting boilerplate...')
    for (const file of BOILERPLATE_FILES) {
      await writeFile(file.path, file.content)
      setFile(file.path, { content: file.content, status: 'complete' })
    }
    console.log('[VIAN] Boilerplate planted.')

    // ── PHASE 2: Start npm install immediately ────────────────────
    // Runs in background — do NOT await.
    // package.json is already planted so this works right away.
    install()

    // ── PHASE 3: Stream AI-generated files ───────────────────────
    const response = await fetch('/api/generate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${getAccessToken()}`,
      },
      body: JSON.stringify({ prompt, model }),
    })

    if (!response.ok) {
      console.error('[VIAN] Generation API error:', response.status)
      setIsGenerating(false)
      return
    }

    const reader = response.body!.getReader()
    const decoder = new TextDecoder()
    let devStarted = false

    while (true) {
      const { done, value } = await reader.read()
      if (done) break

      const lines = decoder.decode(value).split('\n').filter(Boolean)

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue

        let event: { type: string; path?: string; content?: string }
        try {
          event = JSON.parse(line.slice(6))
        } catch {
          continue
        }

        if (event.type === 'file' && event.path && event.content) {

          // Validate path — never overwrite config files
          const PROTECTED = [
            'package.json',
            'next.config.js',
            'tsconfig.json',
            'postcss.config.js',
          ]
          if (PROTECTED.includes(event.path)) {
            console.warn(`[VIAN] AI tried to overwrite ${event.path} — blocked.`)
            continue
          }

          // Write AI file to WebContainer
          await writeFile(event.path, event.content)
          setFile(event.path, { content: event.content, status: 'complete' })

          // Start dev server the moment real page.tsx is written
          if (event.path === 'app/page.tsx' && !devStarted) {
            devStarted = true
            console.log('[VIAN] page.tsx received — starting next dev...')
            startDev()
          }
        }

        if (event.type === 'complete') {
          console.log('[VIAN] Generation complete.')
          setIsGenerating(false)
        }
      }
    }

    setIsGenerating(false)
  }

  return { generate }
}

function getAccessToken(): string {
  if (typeof window === 'undefined') return ''
  return localStorage.getItem('accessToken') ?? ''
}
```

---

## THE WEBCONTAINER HOOK — Full Implementation

```typescript
// apps/web/hooks/useWebContainer.ts
'use client'

import { WebContainer } from '@webcontainer/api'
import { useEffect, useRef, useState } from 'react'

type Status = 'idle' | 'booting' | 'installing' | 'running' | 'error'

export function useWebContainer() {
  const wc = useRef<WebContainer | null>(null)
  const [previewUrl, setPreviewUrl] = useState<string | null>(null)
  const [status, setStatus]         = useState<Status>('idle')
  const [logs, setLogs]             = useState<string[]>([])

  const log = (msg: string) => {
    console.log('[WC]', msg)
    setLogs((prev) => [...prev.slice(-100), msg]) // keep last 100 logs
  }

  useEffect(() => {
    setStatus('booting')
    log('Booting WebContainer...')

    WebContainer.boot()
      .then((instance) => {
        wc.current = instance
        log('WebContainer ready.')
        setStatus('idle')

        instance.on('server-ready', (port, url) => {
          log(`Server ready on port ${port}: ${url}`)
          setPreviewUrl(url)
          setStatus('running')
        })
      })
      .catch((err) => {
        log(`Boot failed: ${err.message}`)
        setStatus('error')
      })
  }, [])

  async function writeFile(path: string, content: string) {
    if (!wc.current) {
      log(`Cannot write ${path} — WebContainer not ready`)
      return
    }
    const dir = path.includes('/') ? path.split('/').slice(0, -1).join('/') : ''
    if (dir) {
      await wc.current.fs.mkdir(dir, { recursive: true })
    }
    await wc.current.fs.writeFile(path, content)
  }

  async function install() {
    if (!wc.current) return
    log('Running npm install...')
    setStatus('installing')

    const proc = await wc.current.spawn('npm', ['install'])
    proc.output.pipeTo(
      new WritableStream({ write: (data) => log(data.trim()) })
    )

    const code = await proc.exit
    if (code !== 0) {
      log(`npm install failed with code ${code}`)
      setStatus('error')
      return
    }
    log('npm install complete.')
  }

  async function startDev() {
    if (!wc.current) return
    log('Starting next dev...')

    const proc = await wc.current.spawn('npm', ['run', 'dev'])
    proc.output.pipeTo(
      new WritableStream({ write: (data) => log(data.trim()) })
    )
    // server-ready event fires → sets previewUrl automatically
  }

  return {
    writeFile,
    install,
    startDev,
    previewUrl,
    status,
    logs,
  }
}
```

---

## AI SYSTEM PROMPT ADDITION — Prepend to every generation call

```
FRAMEWORK: Next.js 14 App Router. TypeScript. Tailwind CSS.

ABSOLUTE RULES:
1. This is Next.js. NEVER generate Vite config, vite.config.ts, or any Vite files.
2. NEVER generate: vite.config.ts, index.html at root, src/main.tsx, src/App.tsx
3. NEVER modify: package.json, next.config.js, tsconfig.json, postcss.config.js
4. These config files are already planted and correct. Do not touch them.
5. Only generate files inside: app/, components/, lib/, hooks/, public/
6. app/page.tsx MUST use Next.js App Router syntax (no ReactDOM.render)
7. All components use 'use client' directive if they use hooks or browser APIs
8. Import styles from app/globals.css only — no other CSS files
9. Use @/* path alias for all imports (e.g. import { cn } from '@/lib/utils')
10. Output: SSE events only. data: {"type":"file","path":"...","content":"..."}
```

---

## ERROR REFERENCE

| Terminal Error | Cause | Fix |
|---|---|---|
| `command not found: vite` | AI generated Vite project | Block AI from touching `package.json` |
| `Couldn't find app directory` | Files at wrong path | Write to `app/page.tsx` not `apps/web/app/page.tsx` |
| `npm install hangs` | Version ranges `^14` | Use exact versions `14.2.5` |
| Blank white screen | CSS missing | Check `app/globals.css` has `@tailwind base` |
| `Cannot find module clsx` | Missing dep | Already in boilerplate `package.json` |
| COOP/COEP error | Missing headers | Already in boilerplate `next.config.js` |
| `Module not found: ./globals.css` | Wrong import path | `app/layout.tsx` must import `'./globals.css'` |
| `ReactDOM.render is deprecated` | Using React 17 API | Use App Router exports, not `ReactDOM.render` |

---

*Plant first. Generate second. Preview always works.*